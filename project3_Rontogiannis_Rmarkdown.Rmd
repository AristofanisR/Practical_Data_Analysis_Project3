---
title: "\\textbf{Simulation}\n\n\\vspace{1cm} \n"
author: "Aristofanis Rontogiannis"
date: "2024-11-27"
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: true
  html_document:
    df_print: paged
subtitle: "Practical Data Analysis - Project 3: A Simulation Study"
link-citations: true
abstract: "**Purpose**: \n\n**Methods**: \n  \n**Results**:\n\n**Conclusions**:\n"
#geometry: margin = 0.75in
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                  message = FALSE,
                  warning = FALSE,
                  error = FALSE)

library(summarytools)
library(ggplot2)
library(knitr)
library(kableExtra)
library(GGally)
library(patchwork)
library(dplyr)
library(reshape2)
library(tidyr)
library(grid)
library(lubridate)
library(gtsummary)
library(gt)
library(ggcorrplot)
library(glmnet)
library(MASS)
library(pROC)
library(gridExtra)
library(VIM)
library(mice)
library(leaps)
library(ggplot2)
library(ggmosaic)
library(ggbeeswarm)
library(ggdist)
library(cowplot)
```

# Introduction

# ADMEP

```{r}
library(lme4)

#' Simulate data for a cluster randomized trial with a hierarchical structure.
#'
#' @param alpha Fixed intercept.
#' @param beta Fixed effect of treatment.
#' @param gamma2 Variance of random cluster effects.
#' @param sigma2 Variance of within-cluster observations.
#' @param G Number of clusters.
#' @param R Number of observations per cluster.
#' @return A data frame containing simulated cluster data with columns `cluster`, `X`, and `Y`.
simulate_cluster_data <- function(alpha, beta, gamma2, sigma2, G, R) {
  
  # Random binary treatment assignment for clusters
  X <- rbinom(G, size = 1, prob = 0.5)
  
  # Random cluster effects
  epsilon <- rnorm(G, mean = 0, sd = sqrt(gamma2))
  
  # Data storage
  data <- data.frame(cluster = rep(1:G, each = R),
                     X = rep(X, each = R),
                     Y = numeric(G * R))
  
  # Generate observations for each cluster
  for (i in 1:G) {
    mu_0 <- alpha + beta * X[i]  # Cluster mean for treatment or control
    mu_i <- mu_0 + epsilon[i]    # Add random cluster effect
    data$Y[data$cluster == i] <- rnorm(R, mean = mu_i, sd = sqrt(sigma2))
  }
  
  return(data)
}


#' Fit a linear mixed-effects model to the simulated data.
#'
#' @param data A data frame containing simulated cluster data with columns `cluster`, `X`, and `Y`.
#' @return The estimated fixed effect (`beta_hat`) for the treatment variable.
fit_model <- function(data) {
  model <- lmer(Y ~ X + (1 | cluster), data = data)
  beta_hat <- fixef(model)["X"]
  return(beta_hat)
}

#' Optimize Experimental Design
#'
#' Iterates through possible combinations of clusters (G) and observations per cluster (R) to find the optimal design that minimizes the variance of the estimated treatment effect.
#'
#' @param alpha Fixed intercept.
#' @param beta Fixed effect of treatment.
#' @param gamma2 Variance of random cluster effects.
#' @param sigma2 Variance of within-cluster observations.
#' @param B Total budget.
#' @param c1 Cost of the first sample from a cluster.
#' @param c2 Cost of additional samples within the same cluster.
#' @param iterations Number of simulations to run for each combination of G and R.
#' @param save_dir Directory to save each simulation result as an RDS file.
#'
#' @return A list containing the optimal combination of G and R (`optimal`) and a data frame of all results (`all_results`).
optimize_design <- function(alpha, beta, gamma2, sigma2, B, c1, c2, iterations = 100, save_dir = "simulation_results") {
 
  if (!dir.exists(save_dir)) dir.create(save_dir)
  
  results <- data.frame(G = integer(), R = integer(), beta_mean = numeric(), beta_var = numeric(), 
                        alpha = numeric(), beta = numeric(), gamma2 = numeric(), 
                        sigma2 = numeric(), c1 = numeric(), c2 = numeric(), B = numeric())
  
  for (G in 2:(B / c1)) {
    R <- floor((B - G * c1) / (c2 * G)) + 1
    if (R < 2) next # Skip if R < 2 (must have at least 2 observations per cluster)
    
    n <- G * R
    if (G >= n) next # Skip if the number of clusters is greater than or equal to the total observations
    
   beta_hats <- numeric(iterations)
    combined_data <- data.frame()  # To store all iterations' data for this G and R
    set.seed(58)
    for (i in 1:iterations) {
      data <- simulate_cluster_data(alpha, beta, gamma2, sigma2, G, R)
      beta_hats[i] <- fit_model(data)
      
      # Combine all iterations' data
      combined_data <- rbind(combined_data, cbind(data, iteration = i))
    }
    
    # Save the combined data for this G and R to a single file
    file_name <- paste0(save_dir, "/simulation_beta", beta, "_G", G, "_R", R, "_gamma2-", gamma2, "_sigma2-", sigma2, "_B", B, "_c1-", c1, "_c2-", c2, ".rds")
    saveRDS(combined_data, file_name)
    beta_mean <- mean(na.omit(beta_hats))
    beta_var <- var(na.omit(beta_hats))
    
    results <- rbind(results, data.frame(G = G, R = R, beta_mean = beta_mean, beta_var = beta_var, 
                                         alpha = alpha, beta = beta, gamma2 = gamma2, 
                                         sigma2 = sigma2, c1 = c1, c2 = c2, B = B))
  }
  
  optimal <- results[which.min(results$beta_var), ]
  return(list(optimal = optimal, all_results = results))
}

```


```{r}
# Plots for G vs beta_var

library(ggplot2)
library(gridExtra)


#' Create a plot showing the effect of number of clusters (G) on the variance of the beta estimate (beta_var) for a specific combination of input parameters.
#'
#' @param alpha Fixed intercept.
#' @param beta Fixed effect of treatment.
#' @param gamma2 Variance of random cluster effects.
#' @param sigma2 Variance of within-cluster observations.
#' @param B Total budget.
#' @param c1 Cost of the first sample from a cluster.
#' @param c2 Cost of additional samples within the same cluster.
#' @param iterations Number of simulations to run.
#' 
#' @return A ggplot object showing G vs. beta_var, with the minimum variance point highlighted.
generate_plot <- function(alpha, beta, gamma2, sigma2, B, c1, c2, iterations = 100) {
  # Run the simulation
  results <- optimize_design(alpha, beta, gamma2, sigma2, B, c1, c2, iterations)
  
  # Find the row with the minimum variance
  min_variance_row <- results$all_results[which.min(results$all_results$beta_var), ]
  
  # Create the plot
  plot <- ggplot(results$all_results, aes(x = G, y = beta_var)) +
    geom_line(color = "purple3") +
    geom_point(size = .5) +
    geom_point(data = min_variance_row, aes(x = G, y = beta_var), color = "red", size = 2) +
    geom_hline(yintercept = min_variance_row$beta_var, linetype = 2, color = "gray40") +
    geom_vline(xintercept = min_variance_row$G, linetype = 2, color = "gray40") +
    geom_text(
      data = min_variance_row,
      aes(x = G, y = beta_var, label = paste0("G = ", G, ", R= ", R, "\nVar = ", round(beta_var, 4))),
      vjust = -1, hjust = 1.2, color = "red", size = 2
    ) +
    ggtitle(bquote(list(beta==.(beta), gamma^2 == .(gamma2), sigma^2 == .(sigma2),
                        B == .(B), c1 == .(c1), c2 == .(c2)
                   ))) +
    labs(
      x = "Number of Clusters (G)",
      y = "Variance of Beta Estimate (beta_var)"
    ) + theme_gray() + 
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.background = element_rect(fill = "gray95"),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.title = element_text(size = 9)
          )
  
  return(plot)
}

#' Generate Multiple Plots for Different Parameter Combinations
#'
#' Runs simulations and generates plots for multiple combinations of input parameters.
#'
#' @param input_combinations A list of parameter combinations, where each element is a list containing:
#'   - `alpha` (Fixed intercept),
#'   - `beta` (Fixed effect of treatment),
#'   - `gamma2` (Variance of random cluster effects),
#'   - `sigma2` (Variance of within-cluster observations),
#'   - `B` (Total budget),
#'   - `c1` (Cost of the first sample from a cluster),
#'   - `c2` (Cost of additional samples within the same cluster).
#' @param iterations Number of simulations to run for each combination.
#' 
#' @return A list of ggplot objects, one for each parameter combination.
generate_multiple_plots <- function(input_combinations, iterations = 100) {
  plots <- lapply(input_combinations, function(inputs) {
    generate_plot(
      alpha = inputs$alpha,
      beta = inputs$beta,
      gamma2 = inputs$gamma2,
      sigma2 = inputs$sigma2,
      B = inputs$B,
      c1 = inputs$c1,
      c2 = inputs$c2,
      iterations = iterations
    )
  })
  
  return(plots)
}

```


```{r, fig.width = 12, fig.height = 6}
# Define a set of input combinations
input_combinations <- list(
  list(alpha = 5, beta = 1, gamma2 = 0.4, sigma2 = 1, B = 5000, c1 = 200, c2 = 5),
  list(alpha = 5, beta = 1, gamma2 = 0.4, sigma2 = 2, B = 5000, c1 = 100, c2 = 5),
  list(alpha = 5, beta = 1, gamma2 = 0.5, sigma2 = 1, B = 5000, c1 = 200, c2 = 5),
  list(alpha = 5, beta = 1, gamma2 = 0.5, sigma2 = 2, B = 5000, c1 = 100, c2 = 5),
  list(alpha = 5, beta = 2, gamma2 = 0.6, sigma2 = 1, B = 5000, c1 = 200, c2 = 5),
  list(alpha = 5, beta = 2, gamma2 = 0.6, sigma2 = 2, B = 5000, c1 = 100, c2 = 5),
  list(alpha = 5, beta = 2, gamma2 = 0.7, sigma2 = 1, B = 5000, c1 = 200, c2 = 10),
  list(alpha = 5, beta = 2, gamma2 = 0.7, sigma2 = 2, B = 5000, c1 = 100, c2 = 10),
  list(alpha = 5, beta = 3, gamma2 = 0.8, sigma2 = 1, B = 5000, c1 = 200, c2 = 10),
  list(alpha = 5, beta = 3, gamma2 = 0.8, sigma2 = 2, B = 5000, c1 = 100, c2 = 10),
  list(alpha = 5, beta = 3, gamma2 = 0.9, sigma2 = 1, B = 5000, c1 = 200, c2 = 10),
  list(alpha = 5, beta = 3, gamma2 = 0.9, sigma2 = 2, B = 5000, c1 = 100, c2 = 10)
) ########################################## Maybe keep B the same to be comparable? (an to kanw na to valw sthn ekfwnisi twn plots kai na to bgalw apo thn upoekfwnisi tou kathe plot)

# Generate all plots
plots <- generate_multiple_plots(input_combinations, iterations = 3) 



library(patchwork)
library(ggpubr)
library(cowplot)
library(egg)

combined_plots = egg::ggarrange(
  plots = plots,
  nrow = 4,
  top = "Effect of G on the Variance of Beta Estimate Across Different Parameters",
  bottom = "Number of clusters (G)",
  left = "Variance of Beta Estimate (beta_var)"
) 


```



## Aims and Objectives

## Data Generating Mechanisms

## Estimands/Targets of Analysis

## Methods to Evaluate

## Performance Measures

# Results

# Conclusion and Limits

# Data Privacy and Code Availability

The analysis .... The replication code can be found at <https://github.com/AristofanisR/Practical_Data_Analysis_Project3>

\newpage

# References

\newpage

# Code Appendix

```{r ref.label = knitr::all_labels(), echo = TRUE, eval = FALSE}
```
